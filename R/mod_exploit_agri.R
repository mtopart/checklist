#' exploit_agri UI Function
#'
#' @description A shiny Module.
#'
#' @param id,input,output,session Internal parameters for {shiny}.
#'
#' @noRd
#'
#' @importFrom shiny NS tagList
#' @importFrom prompter use_prompt  add_prompt
#' @importFrom flexdashboard gaugeOutput renderGauge gauge gaugeSectors
#' @importFrom dplyr %>%
#' @importFrom tibble as_tibble

mod_exploit_agri_ui <- function(id) {
  ns <- NS(id)
  tagList(
    #fluidPage(
      use_prompt(),
      
      ## Contexte général ------------------------------
      
      wellPanel(
        fluidRow(
        column(width = 6,
               checkboxGroupInput(
                 ns("agri_cont"),
                 h5("Contexte général"),
                 width = '100%',
                 c(
                   "Marché, débouchés et concurrence" = "agri_cont_1",
                   "Historique des prix et analyse" = "agri_cont_2",
                   "Variabilité des rendements et/ou de la qualité et analyse" = "agri_cont_3",
                   "Personnes ressources à contacter"  = "agri_cont_4"
                 )
               )),
        
        column(
          width = 6,
          
          textAreaInput(
            inputId = ns("com_agri_cont"),
            label = NULL,
            width = '100%',
            height = '150px',
            placeholder = "Commentaires"
          )
        ),
        
        column(width = 12,
               gaugeOutput(ns("gagri_cont"),
                           height = "100px")
)
        
      )),
      
      
br(),
br(),     
      
      ## Situation particulière ------------------------------
      
      wellPanel(
        style = "background: white;",
        
        fluidRow(
          column(
            width = 6,
            
            checkboxGroupInput(
              ns("agri_cont_sit"),
              h5("Contexte sur une situation particulière"),
              width = '100%',
              c(
                "Phase dans laquelle se situe l'exploitation",
                "Productions et activités (% en temps et/ou en chiffre d'affaires)",
                "Moments marquants dans l'historique",
                "Situation du parcellaire : même tenant ou dispersé, terres  difficiles, …",
                "Actions/implication dans le fonctionnement de l'entreprise ou du collectif",
                "Objectifs de(s) l'agriculteur(s) : sociaux, économiques et stratégiques (y compris privé et familiaux)",
                "Fonctionnement et état des relations au sein du collectif",
                "Articulation entre les ateliers existants"
              )
            )),
            
          
          column(
            width = 6,
            
            textAreaInput(
              inputId = ns("com_agri_cont_sit"),
              label = NULL,
              width = '100%',
              height = '150px',
              placeholder = "Commentaires"
            )
          ),
          
          column(width = 12,      
          
            gaugeOutput(ns("gagri_cont_sit"),
                        height = "100px")
          ))
        ),
          

br(),
br(), 
          
          ## Analyse des impacts ------------------------------
          
          wellPanel(
            
            fluidRow(
              column(
                width = 6,
                
            checkboxGroupInput(
              ns("agri_impacts"),
              h5(
                "Analyse des impacts potentiels d'une production ou d'une pratique sur un système existant "
              ),
              width = '100%',
              c(
                "Sur le travail et l'organisationnel" = "agri_impacts_1",
                "Sur les productions en place" = "agri_impacts_2",
                "Sur le matériel" = "agri_impactst_3",
                "Sur les débouchés, les ventes ou encore les relations clients"  = "agri_impacts_4",
                "Sur les fournisseurs et la logistique" = "agri_impacts_5",
                "Sur la rentabilité et la stabilité des résultats et des revenus" = "agri_impactst_6",
                "Sur la vie personnelle et l'épanouissement"  = "agri_impacts_7"
              )
            )),
            
            
            column(
              width = 6,
              
              textAreaInput(
                inputId = ns("com_agri_impacts"),
                label = NULL,
                width = '100%',
                height = '150px',
                placeholder = "Commentaires"
              )
            ),
            
            
            column(
              width = 12,
            gaugeOutput(ns("gagri_impacts"),
                        height = "100px"))
            )),
          
          br(),
          br(),
          
          
          ## Technique------------------------------
          
          
          wellPanel(
            style = "background: white;",
            
            fluidRow(
              
              column(
                width = 6,
            checkboxGroupInput(
              ns("agri_tech"),
              h5("Technique"),
              width = '100%',
              c(
                "Appropriation technique  et temps nécessaire (aisée, difficile)",
                "Points-clefs techniques et/ou périodes clefs",
                "Conditions les plus propices à la production et/ou stockage",
                "Nouvelles interventions à connaitre",
                "Concurrences avec d'autres activités (y compris activités personnelles) et conséquences",
                "Variabilité potentielle dans les interventions",
                "Conséquences d'un retard",
                "Besoin d'accompagnement spécifique",
                "Réglementations ou normes à connaitre"
              )
            )),
            
            
            column(
              width = 6,
              
              textAreaInput(
                inputId = ns("com_agri_tech"),
                label = NULL,
                width = '100%',
                height = '150px',
                placeholder = "Commentaires"
              )
            ),
            
            
            column(
              width = 12,
            gaugeOutput(ns("gagri_tech"),
                        height = "100px")
            
          )
          )),
          
          br(),
          br(),
          
          ## Travail et MO------------------------------
          
          wellPanel(
            
            fluidRow(
              
              column(
                width = 6,
                
            checkboxGroupInput(
              ns("agri_mo"),
              h5("Travail et main d'oeuvre"),
              width = '100%',
              c(
                "Temps de travail et type de main d'œuvre",
                "Main d'œuvre nécessaire lors des pics de travail et hors pics",
                "Décomposition entre le travail au champ et hors champ",
                "Gestion de la main  d'œuvre",
                "Conséquences des pics de travail sur le reste",
                "Spécificité de la main d'œuvre (formations, compétences, savoir-être …)",
                "Pénibilité"
              )
            )),
            
            column(
              width = 6,
              
              textAreaInput(
                inputId = ns("com_agri_mo"),
                label = NULL,
                width = '100%',
                height = '150px',
                placeholder = "Commentaires"
              )
            ),
            
            
            column(
              width = 12,
            
            gaugeOutput(ns("gagri_mo"),
                        height = "100px")
            
          )
          )),
          
          br(),
          br(),
          
          ## Matériels------------------------------
          
          wellPanel(
            style = "background: white;",
            
            fluidRow(
              
              column(
                width = 6,
            
            checkboxGroupInput(
              "agri_mat",
              h5("Installations et matériels"),
              width = '100%',
              c(
                "Matériels nécessaires et coûts (achat, entretien)",
                "Spécificité du matériel et facilité d'obtention",
                "Possibilité / besoin d'autoconstruction",
                "Possibilité d'avoir accès à du matériel partagé et conséquences",
                "Installations nécessaires et coûts (achat, entretien)"
              )
            )),
            
            column(
              width = 6,
              
              textAreaInput(
                inputId = ns("com_agri_mat"),
                label = NULL,
                width = '100%',
                height = '150px',
                placeholder = "Commentaires"
              )
            ),
            
            
            column(
              width = 12,
            
            gaugeOutput(ns("gagri_mat"),
                        height = "100px")
            
          )
          )),
          
          br(),
          br(),
          
          ## Economique------------------------------
          
          wellPanel(
            
            fluidRow(
              
              column(
                width = 6,
            
            checkboxGroupInput(
              ns("agri_eco"),
              h5("Elements économiques"),
              width = '100%',
              c(
                "Charges de mécanisation ",
                "Charges fixes : annuités, locations",
                "Charges variables (dont intrants, alimentation, frais vétérinaire, gaz, eau, électricité…)",
                "Rémunération (salariés, main d'œuvre familiale)",
                "Chiffre d'affaires (Production et prix) - moyenne et variabilité",
                "Moyenne de chiffres économiques : marges, EBE, valeur ajoutée",
                "Historique sur plusieurs années de chiffres économiques (marges, EBE, valeur ajoutée)",
                "Clefs de réussite et points de vigilance à connaitre vis à vis des prix",
                "Présence d'aides à l'investissement et/ou à la production",
                "Adéquation ou inadéquation avec les attentes de l'agriculteur"
              )
            )),
            
            column(
              width = 6,
              
              textAreaInput(
                inputId = ns("com_agri_eco"),
                label = NULL,
                width = '100%',
                height = '150px',
                placeholder = "Commentaires"
              )
            ),
            
            
            column(
              width = 12,      
            gaugeOutput(ns("gagri_eco"),
                        height = "100px")
            
          )
            )),

fluidRow(
column(12,
       br(),
       hr(),
       br(),
       div( style = "text-align:center",
            downloadButton(ns("dl_1"), "Clic pour télécharger")%>% 
              add_prompt(
                message = "En construction",
                position = "left", type = "success", 
                size = "medium", rounded = TRUE
              )),
       br()))


        )
        
}

#' exploit_agri Server Functions
#'
#' @noRd
mod_exploit_agri_server <- function(id) {
  moduleServer(id, function(input, output, session) {
    ns <- session$ns
    
    
    recap_agri <- reactive({
      list(
        contexte = input$agri_cont,
        cont_sit = input$agri_cont_sit,
        impacts = input$agri_impacts,
        technique = input$agri_tech,
        mo = input$agri_mo,
        mat = input$agri_mat,
        eco = input$agri_eco
      ) %>%
        lengths() %>%
        as.list %>%
        as_tibble
      
    })
    
    
    output$gagri_cont = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$contexte,
        min = 0,
        max = 4,
        sectors = gaugeSectors(
          success = c(3, 4),
          warning = c(2, 3),
          danger = c(0, 2)
        )
      )
    })
    
    
    output$gagri_cont_sit = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$cont_sit,
        min = 0,
        max = 8,
        sectors = gaugeSectors(
          success = c(6, 8),
          warning = c(4, 6),
          danger = c(0, 4)
        )
      )
    })
    
    
    output$gagri_impacts = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$impacts,
        min = 0,
        max = 9,
        sectors = gaugeSectors(
          success = c(6, 9),
          warning = c(3, 6),
          danger = c(0, 3)
        )
      )
    })
    
    
    output$gagri_tech = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$technique,
        min = 0,
        max = 9,
        sectors = gaugeSectors(
          success = c(6, 9),
          warning = c(3, 6),
          danger = c(0, 3)
        )
      )
    })
    
    output$gagri_mo = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$mo,
        min = 0,
        max = 7,
        sectors = gaugeSectors(
          success = c(5, 7),
          warning = c(3, 5),
          danger = c(0, 3)
        )
      )
    })
    
    
    
    output$gagri_mat = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$mat,
        min = 0,
        max = 5,
        sectors = gaugeSectors(
          success = c(4, 5),
          warning = c(3, 4),
          danger = c(0, 3)
        )
      )
    })
    
    output$gagri_eco = renderGauge({
      recap_agri <- recap_agri()
      
      gauge(
        recap_agri$eco,
        min = 0,
        max = 10,
        sectors = gaugeSectors(
          success = c(8, 10),
          warning = c(6, 8),
          danger = c(0, 6)
        )
      )
    })
    
  })
}

## To be copied in the UI
# mod_exploit_agri_ui("exploit_agri_ui_1")

## To be copied in the server
# mod_exploit_agri_server("exploit_agri_ui_1")
